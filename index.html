<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Miss NUNSA Voting</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins&family=Montserrat&family=Dancing+Script&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/css/lightbox.min.css">
</head>
<body>
    <div class="container">
        <div class="header-content">
            <h1>Miss NUNSA National 2025</h1>
            <p class="subtitle">
                Please vote for your preferred contestant and pay the required amount to cast your vote.
            </p>
            <a href="dashboard.html" class="results-button">View Results</a>
        </div>
        
        <div class="contestants-grid">
            <!-- Contestant 1 -->
            <label class="contestant-card" for="contestant1">
                <img src="model 2.jpg" alt="Jane Doe">
                <input type="radio" id="contestant1" name="contestant" value="1">
                <div class="contestant-info">
                    <div class="contestant-name">
                        <a href="https://nunsa.org.ng/wp-content/uploads/2024/12/Lola-Dennis-University-of-Ibadan.pdf" 
                           data-lightbox="contestant-pdf" 
                           data-title="Contestant Profile">
                            Jane Doe
                        </a>
                    </div>
                    <p>22, University of Ibadan</p>
                </div>
                <div class="vote-stepper">
                    <button class="stepper-btn minus" onclick="updateVotes(1, -1); event.stopPropagation()">-</button>
                    <span id="votes1" class="vote-count">1</span>
                    <button class="stepper-btn plus" onclick="updateVotes(1, 1); event.stopPropagation()">+</button>
                </div>
                <p class="vote-price">Total: ₦<span id="total1">50</span></p>
                <button class="vote-button" onclick="processVote(1)">Vote Now</button>
            </label>

            <!-- Contestant 2 -->
            <label class="contestant-card" for="contestant2">
                <img src="model 2.jpg" alt="Mary Smith">
                <input type="radio" id="contestant2" name="contestant" value="2">
                <div class="contestant-info">
                    <div class="contestant-name">
                        <a href="https://nunsa.org.ng/wp-content/uploads/2024/12/Lola-Dennis-University-of-Ibadan.pdf" 
                           data-lightbox="contestant-pdf" 
                           data-title="Contestant Profile">
                            Mary Smith
                        </a>
                    </div>
                    <p>22, University of Ibadan</p>
                </div>
                <div class="vote-stepper">
                    <button class="stepper-btn minus" onclick="updateVotes(2, -1); event.stopPropagation()">-</button>
                    <span id="votes2" class="vote-count">1</span>
                    <button class="stepper-btn plus" onclick="updateVotes(2, 1); event.stopPropagation()">+</button>
                </div>
                <p class="vote-price">Total: ₦<span id="total2">50</span></p>
                <button class="vote-button" onclick="processVote(2)">Vote Now</button>
            </label>

            <!-- Contestant 3 -->
            <label class="contestant-card" for="contestant3">
                <img src="model 2.jpg" alt="Sarah Johnson">
                <input type="radio" id="contestant3" name="contestant" value="3">
                <div class="contestant-info">
                    <div class="contestant-name">
                        <a href="https://nunsa.org.ng/wp-content/uploads/2024/12/Lola-Dennis-University-of-Ibadan.pdf" 
                           data-lightbox="contestant-pdf" 
                           data-title="Contestant Profile">
                            Sarah Johnson
                        </a>
                    </div>
                    <p>22, University of Ibadan</p>
                </div>
                <div class="vote-stepper">
                    <button class="stepper-btn minus" onclick="updateVotes(3, -1); event.stopPropagation()">-</button>
                    <span id="votes3" class="vote-count">1</span>
                    <button class="stepper-btn plus" onclick="updateVotes(3, 1); event.stopPropagation()">+</button>
                </div>
                <p class="vote-price">Total: ₦<span id="total3">50</span></p>
                <button class="vote-button" onclick="processVote(3)">Vote Now</button>
            </label>

            <!-- Contestant 4 -->
            <label class="contestant-card" for="contestant4">
                <img src="model 2.jpg" alt="Alice Brown">
                <input type="radio" id="contestant4" name="contestant" value="4">
                <div class="contestant-info">
                    <div class="contestant-name">
                        <a href="https://nunsa.org.ng/wp-content/uploads/2024/12/Lola-Dennis-University-of-Ibadan.pdf" 
                           data-lightbox="contestant-pdf" 
                           data-title="Contestant Profile">
                            Alice Brown
                        </a>
                    </div>
                    <p>22, University of Ibadan</p>
                </div>
                <div class="vote-stepper">
                    <button class="stepper-btn minus" onclick="updateVotes(4, -1); event.stopPropagation()">-</button>
                    <span id="votes4" class="vote-count">1</span>
                    <button class="stepper-btn plus" onclick="updateVotes(4, 1); event.stopPropagation()">+</button>
                </div>
                <p class="vote-price">Total: ₦<span id="total4">50</span></p>
                <button class="vote-button" onclick="processVote(4)">Vote Now</button>
            </label>
        </div>
    </div>

    <script src="https://js.paystack.co/v1/inline.js"></script>
    <script>
        function updateVotes(contestantId, change) {
            const votesElement = document.getElementById(`votes${contestantId}`);
            let currentVotes = parseInt(votesElement.textContent);
            
            // Ensure votes don't go below 1
            if (currentVotes + change >= 1) {
                currentVotes += change;
                votesElement.textContent = currentVotes;
                
                // Update the total price
                const total = currentVotes * 50;
                document.getElementById(`total${contestantId}`).textContent = total;
            }
        }

        document.querySelectorAll('.contestant-card').forEach(card => {
            card.addEventListener('click', function(e) {
                // Prevent the default radio button behavior
                e.preventDefault();
            });
        });

        function processVote(contestantId) {
            const numberOfVotes = parseInt(document.getElementById(`votes${contestantId}`).textContent);

            if (numberOfVotes < 1) {
                alert('Please enter at least 1 vote');
                return;
            }

            const email = prompt("Please enter your email address:");
            if (!email || !email.includes('@')) {
                alert('Please enter a valid email address');
                return;
            }

            // Get contestant name
            const contestantName = document.querySelector(`#contestant${contestantId}`).closest('.contestant-card')
                .querySelector('.contestant-name a').textContent.trim();

            const amount = numberOfVotes * 50 * 100; // ₦50 per vote in kobo

            let handler = PaystackPop.setup({
                key: 'pk_test_74172d5bbd576149ed2c4394a49d5f815951bbed',
                email: email,
                amount: amount,
                currency: 'NGN',
                ref: 'VOTE_' + Date.now() + '_' + contestantId,
                metadata: {
                    custom_fields: [
                        {
                            contestant_id: contestantId,
                            contestant_name: contestantName,
                            votes: numberOfVotes,
                            email: email
                        }
                    ]
                },
                callback: function(response) {
                    // Send vote and payment data to server
                    const formData = new FormData();
                    formData.append('reference', response.reference);
                    formData.append('contestant_id', contestantId);
                    formData.append('contestant_name', contestantName);
                    formData.append('votes', numberOfVotes);
                    formData.append('email', email);
                    formData.append('amount', amount/100); // Convert back to Naira

                    fetch('https://api.apico.dev/v1/hawAZF/1WTiyw-vWcJ105Og4U45IKRcqewLymV008R_Yf7SO214/values/Sheet1:append?valueInputOption=USER_ENTERED&insertDataOption=INSERT_ROWS&includeValuesInResponse=true', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            "values": [
                                [
                                    new Date().toISOString().replace('T', ' ').slice(0, 19), // Format: YYYY-MM-DD HH:MM:SS
                                    contestantName,
                                    numberOfVotes,
                                    amount/100,
                                    email,
                                    response.reference
                                ]
                            ]
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.updates) {
                            alert(`Thank you! You have successfully cast ${numberOfVotes} vote(s) for ${contestantName}.`);
                            window.location.reload();
                        } else {
                            alert('There was an error recording your vote. Please contact support.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while recording your vote');
                    });
                },
                onClose: function() {
                    // Handle payment window close
                    alert('Transaction cancelled');
                }
            });
            
            handler.openIframe();
        }
    </script>
</body>
</html>